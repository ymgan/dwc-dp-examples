---
title: "Transform Movebank data to a Darwin Core Data Package"
author: "Sanne Govaert"
date: "`r Sys.Date()`"
output: html_document
---

Transforms a Movebank dataset (formatted as a [Frictionless Data Package](https://specs.frictionlessdata.io/data-package/)) to a [Darwin Core Data Package](https://gbif.github.io/dwc-dp/) as part of the public review.

## Initiation

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r library}
library(movepub)
library(dplyr)
library(jsonlite)
library(purrr)
library(frictionless)
library(here)
```

Load example dataset [o_assen](https://inbo.github.io/movepub/reference/o_assen.html) included in movepub R package:

```{r dataset}
movebank_package <- o_assen
```

## Prepare data

Read reference data:

```{r}
ref <- movepub::read_resource(movebank_package, "reference-data") |>
  # Add missing columns
  dplyr::mutate(
    `tag-model` = NA_character_,
    `animal-reproductive-condition` = NA_character_
  )
```

Lookup AphiaIDs for taxa:

```{r}
names <- dplyr::pull(dplyr::distinct(ref, .data$`animal-taxon`))
taxa <- get_aphia_id(names)
```

Read GPS data and subsample to 1 record per animal+tag+date+hour combination:

```{r}
gps <- movepub::read_resource(movebank_package, "gps") |> 
  # Add missing columns
  dplyr::mutate(
    comments = NA_character_,
    `height-above-ellipsoid` = NA_character_
    ) |> 
  # Exclude outliers & (rare) empty coordinates
  dplyr::filter(.data$visible & !is.na(.data$`location-lat`)) |>
  dplyr::mutate(
    time_per_hour = strftime(.data$timestamp, "%y-%m-%d %H %Z", tz = "UTC")
  ) |>
  # Group by animal+tag+date+hour combination
  dplyr::group_by(
    .data$`individual-local-identifier`,
    .data$`tag-local-identifier`,
    .data$time_per_hour
  ) |>
  dplyr::arrange(.data$timestamp) |>
  dplyr::mutate(subsample_count = dplyr::n()) |>
  # Take first record/timestamp within group
  dplyr::filter(dplyr::row_number() == 1) |>
  dplyr::ungroup() |>
  # Join with reference data
  dplyr::left_join(
    ref,
    by = dplyr::join_by(
      "individual-local-identifier" == "animal-id",
      "tag-local-identifier" == "tag-id"
    )
  ) |>
  # Exclude (rare) records outside a deployment
  dplyr::filter(!is.na(.data$`animal-taxon`)) |>
  dplyr::left_join(taxa, by = dplyr::join_by("animal-taxon" == "name")) 
```

## Data transformation

### Event

```{r ref_event}
ref_event <-
  ref |>
  dplyr::mutate(
    .keep = "none",
    eventID = paste(.data$`animal-id`, .data$`tag-id`, "start", sep = "_"),
    parentEventID = paste(.data$`animal-id`, .data$`tag-id`, sep = "_"),
    eventType = "tag attachment",
    eventDate = format(.data$`deploy-on-date`, format = "%Y-%m-%dT%H:%M:%SZ"),
    eventRemarks = paste0(
      dplyr::if_else(
        is.na(.data$`tag-manufacturer-name`),
        "tag ",
        dplyr::if_else(
          is.na(.data$`tag-model`),
          paste(.data$`tag-manufacturer-name`, "tag "),
          paste(.data$`tag-manufacturer-name`, .data$`tag-model`, "tag ")
        )
      ),
      dplyr::if_else(
        !is.na(.data$`attachment-type`),
        paste("attached by", .data$`attachment-type`, "to "),
        "attached to "
      ),
      dplyr::recode(
        .data$`manipulation-type`,
        "none" = "free-ranging animal",
        "confined" = "confined animal",
        "recolated" = "relocated animal",
        "manipulated other" = "manipulated animal",
        .default = "likely free-ranging animal",
        .missing = "likely free-ranging animal"
      ),
      dplyr::if_else(
        !is.na(.data$`deployment-comments`),
        paste0(" | ", .data$`deployment-comments`),
        ""
      )
    ),
    minimumElevationInMeters = NA_real_, # subject to discussion: https://github.com/inbo/movepub/issues/109
    maximumElevationInMeters = NA_real_,
    locationRemarks = NA_character_,
    decimalLatitude = as.numeric(.data$`deploy-on-latitude`),
    decimalLongitude = as.numeric(.data$`deploy-on-longitude`),
    geodeticDatum = dplyr::if_else(
      !is.na(.data$`deploy-on-latitude`),
      "EPSG:4326",
      NA_character_
    ),
    coordinateUncertaintyInMeters = dplyr::if_else(
      !is.na(.data$`deploy-on-latitude`),
      # Assume coordinate precision of 0.001 degree (157m) and recording
      # by GPS (30m)
      187,
      NA_real_
    ),
    dataGeneralizations = NA_character_
  )
```

```{r gps_event}
gps_event <-
  gps |>
  dplyr::mutate(
    .keep = "none",
    eventID = as.character(.data$`event-id`),
    parentEventID = paste(
      .data$`individual-local-identifier`,
      .data$`tag-local-identifier`,
      sep = "_"
    ),
    eventType = "gps",
    eventDate = format(.data$timestamp, format = "%Y-%m-%dT%H:%M:%SZ"),
    eventRemarks = dplyr::coalesce(.data$`comments`, ""),
    minimumElevationInMeters = dplyr::coalesce(
      .data$`height-above-msl`,
      as.numeric(.data$`height-above-ellipsoid`),
      NA_real_
    ),
    maximumElevationInMeters = dplyr::coalesce(
      .data$`height-above-msl`,
      as.numeric(.data$`height-above-ellipsoid`),
      NA_real_
    ),
    locationRemarks = dplyr::case_when(
      !is.na(.data$`height-above-msl`) ~
        "elevations are altitude above mean sea level",
      !is.na(.data$`height-above-ellipsoid`) ~
        "elevations are altitude above ellipsoid"
    ),
    decimalLatitude = as.numeric(.data$`location-lat`),
    decimalLongitude = as.numeric(.data$`location-long`),
    geodeticDatum = "EPSG:4326",
    coordinateUncertaintyInMeters =
      as.numeric(.data$`location-error-numerical`),
    dataGeneralizations = paste(
      "subsampled by hour: first of", .data$subsample_count, "record(s)"
    )
  )
```

```{r}
parent_event <-
  ref |> 
  dplyr::mutate(
    .keep = "none", 
    eventID = paste(.data$`animal-id`, .data$`tag-id`, sep = "_"),
    parentEventID = paste(.data$`animal-id`, .data$`tag-id`, sep = "_"), # Will be set to NA later
    eventType = "deployment",
    eventDate = dplyr::case_when(
      !is.na(.data$`deploy-off-date`) ~
        paste(
          format(.data$`deploy-on-date`, format = "%Y-%m-%dT%H:%M:%SZ"),
          format(.data$`deploy-off-date`, format = "%Y-%m-%dT%H:%M:%SZ"),
          sep = "/"
        ),
        .default = format(.data$`deploy-on-date`, format = "%Y-%m-%dT%H:%M:%SZ")
    ),
    eventRemarks = NA_character_,
    minimumElevationInMeters = NA_real_,
    maximumElevationInMeters = NA_real_,
    locationRemarks = NA_character_,
    decimalLatitude = NA_real_,
    decimalLongitude = NA_real_,
    geodeticDatum = NA_character_,
    coordinateUncertaintyInMeters = NA_real_,
    dataGeneralizations = NA_character_
  )
```

```{r event}
event <-
  parent_event |>
  dplyr::bind_rows(ref_event) |>
  dplyr::bind_rows(gps_event) |>
  distinct() |> 
  dplyr::mutate(
    # DATASET-LEVEL
    datasetName = movebank_package$title,
    datasetID = movebank_package$id,
    .before = "eventDate"
  ) |>
  dplyr::arrange(.data$parentEventID, .data$eventDate) |>
  dplyr::mutate(
    parentEventID = dplyr::if_else(
      .data$eventID == .data$parentEventID,
      NA_character_,
      .data$parentEventID
    )
  )
```

### Occurrence

```{r ref_occurrence}
ref_occurrence <-
  ref |> 
  dplyr::filter(!is.na(.data$`deploy-on-date`)) |> 
  dplyr::left_join(taxa, by = dplyr::join_by("animal-taxon" == "name")) |> 
  dplyr::mutate(
    .keep = "none",
    occurrenceID = paste(
      .data$`animal-id`, .data$`tag-id`, "start", sep = "_" # Same as eventID
    ),
    eventID = paste(.data$`animal-id`, .data$`tag-id`, "start", sep = "_"),
    sex = dplyr::recode(
      .data$`animal-sex`,
      "m" = "male",
      "f" = "female",
      "u" = "unknown"
    ),
    lifeStage = .data$`animal-life-stage`,
    reproductiveCondition = .data$`animal-reproductive-condition`,
    occurrenceStatus = "present",
    organismID = .data$`animal-id`,
    organismName = .data$`animal-nickname`,
    scientificNameID = .data$aphia_lsid,
    scientificName = .data$`animal-taxon`,
    taxonRank = "species"
  )
```

```{r}
gps_occurrence <-
  gps |> 
  dplyr::mutate(
    .keep = "none",
    occurrenceID = as.character(.data$`event-id`),
    eventID = as.character(.data$`event-id`),
    sex = dplyr::recode(
      .data$`animal-sex`,
      "m" = "male",
      "f" = "female",
      "u" = "unknown"
    ),
    # Value at start of deployment might not apply to all records
    lifeStage = NA_character_,
    reproductiveCondition = NA_character_,
    occurrenceStatus = "present",
    organismID = .data$`individual-local-identifier`,
    organismName = .data$`animal-nickname`,
    scientificNameID = .data$aphia_lsid,
    scientificName = .data$`animal-taxon`,
    taxonRank = "species"
  )
```

```{r occurrence}
occurrence <-
  ref_occurrence |>
  dplyr::bind_rows(gps_occurrence) |>
  dplyr::arrange(eventID)
```

### Occurrence Assertion

```{r occurrence-assertion}
sex <-
  ref_occurrence |>
  dplyr::mutate(
    .keep = "none",
    occurrenceID = .data$occurrenceID,
    assertionType = "sex",
    assertionTypeIRI =
      "http://vocab.nerc.ac.uk/collection/P01/current/ENTSEX01/",
    assertionValue = .data$sex, # Value as is
    assertionValueIRI = dplyr::recode(
      .data$sex,
      "female" = "http://vocab.nerc.ac.uk/collection/S10/current/S102/",
      "male" = "https://vocab.nerc.ac.uk/collection/S10/current/S103/",
      "unknown" = "https://vocab.nerc.ac.uk/collection/S10/current/S105/", # indeterminate
      .default = NA_character_, # Don't map other values
      .missing = "https://vocab.nerc.ac.uk/collection/S10/current/S104/" # not specified
    )
  )

lifestage <-
  ref_occurrence |>
  dplyr::mutate(
    .keep = "none",
    occurrenceID = .data$occurrenceID,
    assertionType = "life stage",
    assertionTypeIRI =
      "http://vocab.nerc.ac.uk/collection/P01/current/LSTAGE01/",
    assertionValue = .data$lifeStage, # Value as is
    assertionValueIRI = dplyr::recode(
      .data$lifeStage,
      "adult" = "http://vocab.nerc.ac.uk/collection/S11/current/S1116/",
      "subadult" = "https://vocab.nerc.ac.uk/collection/S11/current/S120/", # sub-adult
      "juvenile" = "https://vocab.nerc.ac.uk/collection/S11/current/S1127/",
      "unknown" = "http://vocab.nerc.ac.uk/collection/S11/current/S1152/", # indeterminate
      .default = NA_character_, # Don't map other values
      .missing = "http://vocab.nerc.ac.uk/collection/S11/current/S1131/" # not specified
    )
  )

occurrence_assertion <-
  dplyr::bind_rows(sex, lifestage) |>
  dplyr::arrange(.data$occurrenceID)
```

## Create Darwin Core Data Package

### Prepare table schemas

```{r table schema event}
schema_event <- jsonlite::fromJSON("https://raw.githubusercontent.com/gbif/dwc-dp/0.1/dwc-dp/table-schemas/event.json", simplifyDataFrame = FALSE, simplifyVector = TRUE)

schema_event$fields <- purrr::keep(schema_event$fields, ~ .x$name %in% names(event))
schema_event$foreignKeys <- purrr::keep(schema_event$foreignKeys, ~ .x$fields %in% c("parentEventID"))
```

```{r table schema occurrence}
schema_occurrence <- jsonlite::fromJSON("https://raw.githubusercontent.com/gbif/dwc-dp/0.1/dwc-dp/table-schemas/occurrence.json", simplifyDataFrame = FALSE, simplifyVector = TRUE)

schema_occurrence$fields <- purrr::keep(schema_occurrence$fields, ~ .x$name %in% names(occurrence))
schema_occurrence$foreignKeys <- purrr::keep(schema_occurrence$foreignKeys, ~ .x$fields %in% c("eventID"))
```

```{r table schema occurrenceAssertion}
schema_occurrence_assertion <- jsonlite::fromJSON("https://raw.githubusercontent.com/gbif/dwc-dp/0.1/dwc-dp/table-schemas/occurrence-assertion.json", simplifyDataFrame = FALSE, simplifyVector = TRUE)

schema_occurrence_assertion$fields <- purrr::keep(schema_occurrence_assertion$fields, ~ .x$name %in% names(occurrence_assertion))
schema_occurrence_assertion$primaryKey <- NULL
schema_occurrence_assertion$foreignKeys <- purrr::keep(schema_occurrence$foreignKeys, ~ .x$fields %in% c("occurrenceID"))
```

### Create DP

```{r dwcDP}
dwc_dp <-
  frictionless::create_package() |> 
  frictionless::add_resource(
    resource_name = "event",
    data = event,
    schema = schema_event
  ) |> 
  frictionless::add_resource(
    resource_name = "occurrence",
    data = occurrence,
    schema = schema_occurrence
  ) |>
  frictionless::add_resource(
    resource_name = "occurrence-assertion",
    data = occurrence_assertion,
    schema = schema_occurrence_assertion
  ) |>
  append(
    c(
      profile = "https://raw.githubusercontent.com/gbif/dwc-dp/0.1/dwc-dp/dwc-dp-profile.json",
      name = "bird-tracking-example",
      title = "Bird tracking (Movebank) Observation Example"
    ),
    after = 0
  ) |> 
  frictionless::create_package()
```

## Write data

```{r}
frictionless::write_package(dwc_dp, here::here("observation", "bird-tracking", "output_data"))
```

## Compare with Darwin Core Archive

```{r}
dwc <- movepub::write_dwc(movebank_package, directory = "my_directory")
unlink("my_directory", recursive = TRUE)

nrow(dwc$occurrence) == nrow(occurrence)
nrow(dwc$emof) == nrow(occurrence_assertion)
```
